Codex Instructions (Codex 5.3)
==============================

Status (2026-02-14)
------------------
Baseline already in place (do not redo):
- Numeric chunk keys end-to-end (world dirty/streaming, renderer caches/queues, threaded meshing jobs/results).
- Threaded meshing worker pipeline with blob fast paths + versioned result rejection.
- Finite chunked world: procedural base + sparse overrides (edits + features), bedrock unbreakable.
- Save/load (V2 magic) for edits + player + inventory + time-of-day.

New task: Implement "Recommended Next Steps" from `Audit Results #2`
-------------------------------------------------------------------

Goal
----
Address the following without changing gameplay:
1) Remove per-frame allocations in the camera/view path (`GameState` view vec3 + `Player` camera orientation quats).
2) Fullscreen persistence: either make it distribution-friendly OR explicitly treat `.fullscreen` as a local-dev artifact (and ignore it).
3) Sync `AGENTS.md` control wording with actual behavior.
4) Add third-party license/attribution for vendored `lovr-mouse.lua`.
5) (If large saves are expected) Add a bulk edit-apply path for save loading to avoid long startup hitches.

Hard constraints (do NOT change)
-------------------------------
- Pointer lock / relative mouse flow (`lovr-mouse.lua`) and all input + menu behavior.
- Save format and on-disk representation. (Bulk-apply is internal only.)
- World bounds (finite world) and bedrock unbreakable.
- Block IDs, colors, and opaque/alpha semantics (leaves remain translucent).
- Renderer rebuild scheduling/budgeting, incremental pruning, and threaded meshing fallback behavior.
- Keep files ASCII when practical.
- Update `DEVLOG.md` for meaningful changes and `README.md` for control changes.

Implementation plan (do in this order)
--------------------------------------

1) Fix camera/view allocations (required)
Files: `src/game/GameState.lua`, `src/player.lua`

Tasks
- `GameState`: stop calling `lovr.math.vec3(...)` each frame in `draw`.
  - Store a persistent `lovr.math.newVec3` on the `GameState` instance and update it with `:set(x, y, z)` (or field writes if needed).
  - Use it in `pass:setViewPose(...)`.
- `Player`: rewrite `getCameraOrientation` to reuse quaternions instead of allocating each call.
  - Use `Quat:set(angle, ax, ay, az)` and `Quat:mul(quat)` (in-place) rather than `lovr.math.newQuat(...)` and `yaw * pitch`.
  - Return a cached `Quat` owned by the player (callers treat it as read-only within the frame).

Acceptance checks
- `rg -n "lovr\\.math\\.vec3\\(" src/game/GameState.lua` returns no results.
- `Player:getCameraOrientation()` does not call `lovr.math.newQuat` and does not use `*` to combine quats.
- Manual: mouse look feels identical, no camera roll, no rendering/culling regressions.

2) Fullscreen persistence + git hygiene (required)
Files: `conf.lua`, `src/game/GameState.lua`, `.gitignore`, `README.md` (only if behavior changes)

Default approach (recommended unless user asks otherwise)
- Treat `.fullscreen` as a local-dev artifact:
  - Add `.fullscreen` to `.gitignore`.
  - Keep current restart-based toggle behavior.
  - Ensure failures to read/write do not crash (already mostly true; keep it that way).

Alternative (only if requested and verified)
- Implement a distribution-friendly preference location. Do NOT guess module availability in `conf.lua`:
  - `conf.lua` runs before modules initialize; avoid relying on `lovr.filesystem` there unless verified in LOVR 0.18.
  - If you change where fullscreen state is stored, update `README.md` accordingly.

Acceptance checks
- `.fullscreen` no longer shows up as an untracked file after toggling fullscreen.
- `F11` still toggles fullscreen and persists across restart (within the dev workflow).

3) Docs sync (required)
Files: `AGENTS.md` (and `README.md` only if controls changed)

Tasks
- Update `AGENTS.md` control wording for Escape to match actual behavior:
  - Escape unlocks mouse if locked; otherwise opens the pause menu.
- Do NOT change input behavior to match docs; docs should match behavior.

Acceptance checks
- `AGENTS.md` and `README.md` do not contradict each other about Escape behavior.

4) Third-party license/attribution for `lovr-mouse.lua` (required)
Files: add `THIRD_PARTY_NOTICES.md` (or `LICENSES/lovr-mouse.txt`), optionally update `README.md`

Rules
- Do NOT invent license text. Locate the actual license from upstream (`bjornbytes/lovr-mouse`) and copy it in.
- Record provenance: project name + upstream URL + license type + license text, and ideally a commit/tag if available.

If network access is unavailable
- Ask the user to provide the license text (or allow fetching it); do not add placeholders that imply a license.

Acceptance checks
- Repo contains a third-party notice or license file that clearly covers `lovr-mouse.lua`.

5) Bulk edit-apply on load (optional but recommended for large saves)
Files: `src/save/SaveSystem.lua` and/or `src/world/ChunkWorld.lua`

Goal
- Keep save format identical, but avoid `world:set(...)` per-edit on load.
- Preserve correctness:
  - AIR edits (block id 0) must remain valid overrides (do not treat as "no edit").
  - Chunks affected by edits must be marked dirty (and neighbor chunks when an edit touches a chunk boundary) so meshes rebuild correctly.

Suggested approach
- Add a world method like `ChunkWorld:applyEditsBulk(edits, count)` that:
  - Inserts entries into `_editChunks` / `_editChunkCounts` / `_editCount` directly.
  - Marks dirty per affected chunk, and boundary neighbors (can batch per-chunk with boundary flags).
- In `SaveSystem:apply`, prefer bulk apply if present; otherwise fall back to per-edit `world:set`.

Acceptance checks
- Loading a save with many edits is noticeably faster and does not hitch as long.
- Manual: break/place near chunk boundaries still causes both chunks to rebuild after load (no seams).

Verification searches (required)
--------------------------------
- `rg -n "lovr\\.math\\.vec3\\(" src`
- `rg -n "newQuat\\(" src/player.lua`
- `rg -n \"\\.fullscreen\" .gitignore conf.lua src/game/GameState.lua README.md`
- `rg -n \"lovr-mouse\" README.md AGENTS.md THIRD_PARTY_NOTICES.md LICENSES -S`

Manual test checklist (required)
--------------------------------
Run: `lovr .`

Checklist
- Camera: look around, move, jump; orientation is correct (yaw/pitch only).
- Fullscreen: press `F11`, app restarts, fullscreen state persists; `.fullscreen` is not committed/untracked noise.
- Pause/menu: Escape behavior unchanged (unlock vs pause menu) and matches docs.
- Pointer lock: click to capture; Tab toggle; focus loss unlock still works.
- Save/load: make a few edits, save, quit to menu, continue; world edits and inventory persist.

Deliverables
------------
- Per-frame camera allocations removed.
- `.fullscreen` strategy clarified and repository stays clean.
- Docs are consistent.
- Third-party notice/license added for `lovr-mouse.lua`.
- (Optional) Save load bulk apply implemented without format changes.
