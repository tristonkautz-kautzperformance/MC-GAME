Codex Instructions (Codex 5.3)
==============================

Status (2026-02-10)
------------------
- Next task is a correctness fix (no new features): prevent blocks from disappearing when the inventory/hotbar is full.
- Controls must not change; `F3` must still toggle the performance HUD on/off.

Goal
----
Fix the edge case where breaking a block can delete it from the world even when it cannot be added to the player's
inventory (inventory full).

Background / Bug
----------------
In `src/interaction/Interaction.lua`, `Interaction:tryBreak()` currently:
1) sets the world block to AIR, then
2) calls `Inventory:add(block, 1)`

If `Inventory:add` returns `false` (no room), the block is already removed and is effectively lost ("disappears").

Desired Behavior (V1)
---------------------
- Breaking a block should never delete it without giving the player the item.
- If the inventory cannot accept the block, the break action should do nothing (leave the block intact).
- Do NOT implement item drops for this task.
- Do NOT change inputs/controls; `F3` still toggles perf HUD.

Implementation Plan
-------------------

1) Add capacity check API to Inventory

File: `src/inventory.lua`
Add:
- `Inventory:canAdd(block, amount)` -> boolean

Rules:
- Return `false` if `block` is nil or `amount <= 0`.
- Return `true` if there is an existing slot where `slot.block == block` (stacking is allowed; there is no max stack).
- Return `true` if there is an empty slot:
  - `slot.block == nil`, OR
  - `slot.count == 0` (treat as empty even if `slot.block` is set).
- Return `false` otherwise.

Notes:
- Keep it allocation-free (no temporary tables); just loops over `self.slots`.
- Keep `Inventory:add` behavior unchanged, except it can optionally use `canAdd` to early-return `false`.

2) Gate breaking on inventory capacity

File: `src/interaction/Interaction.lua`
Update `Interaction:tryBreak()`:
- After reading the `block` and confirming it is breakable, check inventory capacity:
  - If `not self.inventory:canAdd(block, 1)` then return (no world change).
- If capacity is available:
  - `self.world:set(hit.x, hit.y, hit.z, self.constants.BLOCK.AIR)`
  - `self.inventory:add(block, 1)`

Rationale:
- This keeps the world mutation single-pass (no "break then undo").
- It prevents the "block disappears" case without needing a drop system.

3) Optional (nice-to-have): player feedback when inventory is full

If quick and low-risk, add a short HUD message like "Inventory full" when a break is blocked.
Keep it simple:
- Add a `state.message` string + `state.messageTimer` in `GameState` (or similar).
- When break fails due to `canAdd == false`, set message for ~1 second.
- In `HUD:draw`, render the message near the tip text.

This is optional; correctness fix (no disappearing blocks) is the requirement.

Manual Test Checklist
---------------------

A) Baseline sanity
- Start game, capture mouse, move/look.
- Break/place blocks normally.
- Verify `F3` toggles perf HUD on/off (no regressions).

B) Repro inventory-full case (the default game canâ€™t easily fill 8 slots with only a few block types)
TEMPORARY TEST CONFIG (do not commit):
- Edit `src/constants.lua`:
  - Set `Constants.INVENTORY_SLOT_COUNT = 2`
  - Set `Constants.HOTBAR_DEFAULTS = { Constants.BLOCK.GRASS }`

Then:
- Start game.
- Break a `Stone` block: inventory should now contain Grass + Stone (2 slots full).
- Attempt to break a `Dirt` block:
  - EXPECTED after fix: Dirt block remains in the world (not removed).
  - EXPECTED before fix: Dirt would be removed and not appear in inventory.

After verification:
- Revert the temporary constants changes.

Acceptance Criteria
-------------------
- When inventory is full and cannot accept a new block type, attempting to break that block does not remove it.
- No control changes; `F3` perf HUD toggle still works.
- No per-frame allocation regressions (changes are in interaction/inventory code paths only).
